<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Select Charger - flashCharge</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="select-charger.css">
</head>
<body>
  <div class="mobile-container">
    <div class="mobile-header">
      <h1>
        <span>âš¡ Charging Stations</span>
        <button id="logout-btn" class="logout-btn">Logout</button>
      </h1>
      <p class="page-subtitle">Select a connector to start charging</p>
    </div>

    <div id="station-grid" class="station-grid">
      <div class="loading">Loading stations...</div>
    </div>
  </div>

  <script>
    const API = '/api';
    const WS_URL = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`;
    const CHARGERS = ['RIVOT_100A_01', 'RIVOT_100A_02'];
    const wsConnections = new Map();

    function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return token ? { 'Authorization': `Bearer ${token}` } : {};
    }

    function connectWebSocket(chargerId) {
      const token = localStorage.getItem('authToken');
      if (!token) return;
      
      const ws = new WebSocket(`${WS_URL}?charger=${chargerId}&token=${token}`);
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'update') {
          updateConnectorStatusRealtime(chargerId, data.status);
        }
      };
      
      ws.onclose = (event) => {
        if (event.code === 4001 || event.code === 4002) {
          localStorage.removeItem('authToken');
          window.location.replace('/login.html');
          return;
        }
        setTimeout(() => connectWebSocket(chargerId), 3000);
      };
      
      wsConnections.set(chargerId, ws);
    }

    function updateConnectorStatusRealtime(chargerId, status) {
      const card = document.querySelector(`[data-charger="${chargerId}"]`);
      if (!card) return;
      
      const guns = card.querySelectorAll('.gun-visual');
      guns.forEach((gun, index) => {
        const connectorId = index + 1;
        const statusClass = getStatusClass(status);
        gun.className = `gun-visual ${statusClass}`;
        
        const statusEl = gun.parentElement.querySelector('.gun-status');
        if (statusEl) {
          statusEl.className = `gun-status ${statusClass}`;
          statusEl.innerText = status;
        }
      });
    }

    function getGunIcon(status) {
      if (status === 'Charging') return 'ðŸ”Œ';
      if (status === 'Available') return 'âš¡';
      if (status === 'Preparing') return 'ðŸ”‹';
      return 'âŒ';
    }

    function getStatusClass(status) {
      if (status === 'Available') return 'available';
      if (status === 'Charging') return 'charging';
      if (status === 'Preparing' || status === 'Finishing') return 'preparing';
      return 'unavailable';
    }

    async function loadStations() {
      const grid = document.getElementById('station-grid');
      grid.innerHTML = '';

      for (const chargerId of CHARGERS) {
        try {
          const res = await fetch(`${API}/chargers/${chargerId}/connectors`, {
            headers: getAuthHeaders()
          });
          
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          
          const connectors = await res.json();

          const card = document.createElement('div');
          card.className = 'station-card';
          card.setAttribute('data-charger', chargerId);

          let gunsHtml = '';
          connectors.forEach(conn => {
            // Connector 0 is not used, mark as unavailable
            const actualStatus = conn.connectorId === 0 ? 'Unavailable' : conn.status;
            const statusClass = getStatusClass(actualStatus);
            const isClickable = conn.connectorId !== 0 && (actualStatus === 'Available' || actualStatus === 'Preparing');
            const clickHandler = isClickable ? `onclick="selectConnector('${chargerId}', ${conn.connectorId})"` : '';
            
            gunsHtml += `
              <div class="gun-wrapper">
                <div class="gun-visual ${statusClass}" ${clickHandler}>
                  <div class="gun-icon">${getGunIcon(actualStatus)}</div>
                  <div class="gun-label">Gun ${conn.connectorId}</div>
                </div>
                <div class="gun-status ${statusClass}">${actualStatus}</div>
              </div>
            `;
          });

          card.innerHTML = `
            <div class="station-header">
              <div class="station-icon">âš¡</div>
              <div class="station-info">
                <div class="station-name">${chargerId}</div>
                <div class="station-subtitle">DC Fast Charger â€¢ 11kW</div>
              </div>
            </div>
            <div class="guns-container">
              ${gunsHtml}
            </div>
          `;

          grid.appendChild(card);
        } catch (error) {
          console.error(`Error loading ${chargerId}:`, error);
        }
      }
    }

    window.selectConnector = function(chargerId, connectorId) {
      window.location.href = `/configure-charge.html?charger=${chargerId}&connector=${connectorId}`;
    };

    document.getElementById('logout-btn').onclick = () => {
      localStorage.removeItem('authToken');
      window.location.href = '/login.html';
    };

    window.onload = () => {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.replace('/login.html');
        return;
      }

      loadStations();
      
      // Connect WebSocket for each charger
      CHARGERS.forEach(chargerId => connectWebSocket(chargerId));
      
      // Fallback polling every 30s
      setInterval(loadStations, 30000);
    };
  </script>
</body>
</html>